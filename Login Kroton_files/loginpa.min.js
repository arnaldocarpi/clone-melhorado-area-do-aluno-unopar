var $document=$(document),lastAttempts=0;Date.now||(Date.now=function(){return(new Date).getTime()}),$document.ready(function(){var e=$("#klogin"),t=$(".js-alert"),a=$("#btnLogin"),o=$("#unidade"),n=$("#username"),r=$("#password"),s=$(".js-acesso");t.html("").hide(),e.show(),$document.on("submit","#klogin",function(s){s.preventDefault();var i=e,c=Date.now();if(o.length>0&&("0"===o.val()||!o.val()))return t.text("Por favor, informe a unidade.").show(),!1;var l=n.val();if(""===l||""===r.val())return t.html("Por favor preencha os campos de usuário e senha.").show(),!1;t.html("").hide(),a.prop("disabled",!0).text("Entrando..."),$.post(i.attr("action"),i.serialize(),function(o){if(o&&o.sucesso&&o.url){window.location.href=o.url;var n=o.nome.split(" ");t.removeClass("alert-danger").addClass("alert-success").text("Olá "+n[0]+"! Acessando seu portal...").show(),e.fadeOut(),gtag("event","sucesso",{event_category:"login",event_label:"Login efetuado",value:Date.now()-c});var r=o.url.indexOf("AuthorizeAluno")>=0?"cpf":"ra";l.indexOf("@")>0&&(r="email"),gtag("event",r,{event_category:"metodo-login",event_label:"Entrou por "+r})}else if(o&&o.erro){if(a.prop("disabled",!1).html('<span class="glyphicon glyphicon-log-in"></span>&nbsp;Entrar'),t.text(o.msg).show(),null!==o.url&&$("#btnCase").attr("href",o.url).show(),o.attemptsUser>5&&o.attemptsDevice>o.attempts)try{grecaptcha.render("captcha",{sitekey:captchaKey}),gtag("event","captcha",{event_category:"estatisticas",event_label:"captcha"})}catch(e){}else lastAttempts>o.attempts&&o.attemptsDevice<o.attempts&&window.location.reload();lastAttempts=o.attemptsDevice,gtag("event",o.erro||"semacesso",{event_category:"login",event_label:o.msg}),o.attemptsUser>=2&&($("#trb").show(),gtag("event","exibir-solucao-problemas",{event_category:"estatisticas",event_label:"Mostrou o link que permite abrir um chamado"}))}else a.prop("disabled",!1).html('<span class="glyphicon glyphicon-log-in"></span>&nbsp;Entrar'),t.html("Ocorreu um erro no sistema ao entrar.<br>Por favor tente novamente.").show(),gtag("event","erro",{event_category:"login",event_label:"Erro ao logar (desconhecido)",value:"desconhecido"})}).fail(function(e){if(429===e.status){t.text("Dispositivo bloqueado para novas requisições nas próximas 24 horas. Tente com outro dispositivo ou aguarde o tempo de 24 horas e não faça novas tentativas neste período.").show();try{grecaptcha.render("captcha",{sitekey:captchaKey}),gtag("event","captcha",{event_category:"estatisticas",event_label:"captcha",value:"desconhecido"})}catch(e){}gtag("event","bloqueado",{event_category:"login",event_label:"Dispositivo bloqueado",value:"desconhecido"})}else{var o=navigator.onLine?"":"Verifique sua conexão com a Internet!";t.text("["+e.status+"] Ocorreu um erro desconhecido ao tentar entrar. Tente novamente. "+o).show(),a.prop("disabled",!1).html('<span class="glyphicon glyphicon-log-in"></span>&nbsp;Entrar'),gtag("event",e.status||"erro-conexao",{event_category:"login",event_label:"Erro ao logar (conexão)"})}})}),$document.on("click",".js-acesso",function(e){t.html("").hide(),o.length>0&&("0"===o.val()||!o.val())&&(e.preventDefault(),t.text("Por favor, informe a unidade para continuar.").show())}),$document.on("change","#unidade",function(){var e=o.val();"0"!==e&&e&&s.each(function(t,a){var o=$(a),n=o.attr("href").split("?");o.attr("href",n[0]+"?codUni="+e)})}),$document.on("click",".js-ead",function(e){e.preventDefault(),$("#username").focus().select().parent().popover({content:"Agora você pode acessar diretamente por aqui, use seu login (RA, CPF ou e-mail) e senha do Colaborar:",placement:"top",trigger:"trigger"}).popover("show"),gtag("event","ead",{event_category:"estatisticas",event_label:"Tentou acessar o EAD pelo botão indicado"})}),a.prop("disabled",!1),o.trigger("change")});